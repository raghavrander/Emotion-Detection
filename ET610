{"cells":[{"cell_type":"code","source":["from google.colab import drive\n","drive.mount('/content/drive')"],"metadata":{"id":"TolJM20niYVG","executionInfo":{"status":"ok","timestamp":1669114851103,"user_tz":-330,"elapsed":24019,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"35d2234d-f32c-4c5e-db69-c94633dd25f1","colab":{"base_uri":"https://localhost:8080/"}},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}]},{"cell_type":"code","source":["import numpy as np\n","import pandas as pd\n","import tensorflow as tf\n","from keras.layers.core import Dense, Activation, Dropout, Flatten\n","from keras.layers.convolutional import Convolution2D, MaxPooling2D\n","# from keras.optimizers import SGD, RMSprop, adam\n","from keras.utils import np_utils\n","from sklearn.tree import DecisionTreeClassifier # Import Decision Tree Classifier\n","from sklearn import metrics\n","from sklearn.utils import shuffle\n","from sklearn.model_selection import train_test_split\n","import matplotlib.image as mpimg\n","import matplotlib.pyplot as plt\n","import numpy as np\n","import os\n","import cv2\n","import random\n","from numpy import *\n","from PIL import Image\n","# import theano\n","data = pd.DataFrame(pd.read_csv('/content/drive/MyDrive/ET610-Endsem-Q1/labels_new.csv'))"],"metadata":{"id":"i7sQGhfUiZkQ"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["data.info()"],"metadata":{"id":"q1_RCBWwifQC","executionInfo":{"status":"ok","timestamp":1669114866463,"user_tz":-330,"elapsed":388,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"271d6442-2bfb-4fc2-c52b-8746d51e59a2","colab":{"base_uri":"https://localhost:8080/"}},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["<class 'pandas.core.frame.DataFrame'>\n","RangeIndex: 1640 entries, 0 to 1639\n","Data columns (total 2 columns):\n"," #   Column  Non-Null Count  Dtype \n","---  ------  --------------  ----- \n"," 0   image   1640 non-null   object\n"," 1   Raghav  1640 non-null   int64 \n","dtypes: int64(1), object(1)\n","memory usage: 25.8+ KB\n"]}]},{"cell_type":"markdown","source":["Loading the images into an array"],"metadata":{"id":"gxFzcQCxq2Sh"}},{"cell_type":"code","source":["arr=[]\n","for i in range(0,164):\n","  for j in range(1,11):\n","    image = tf.keras.utils.load_img('/content/drive/MyDrive/ET610-Endsem-Q1/Data/'+(str)(i)+'_'+(str)(j)+'.jpg', grayscale=False,\n","    color_mode='rgb',\n","    target_size=(30,30,1),\n",")\n","    input_arr1 = tf.keras.utils.img_to_array(image)\n","    arr.append(input_arr1)  # Convert single image to a batch."],"metadata":{"id":"8JbQAJcfi1H-"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["image_labels = data.iloc[:,1:].values"],"metadata":{"id":"OtvRBUplsaUd"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["print(image_labels)\n","print(type(image_labels))"],"metadata":{"id":"NY7RXzAJn7is","executionInfo":{"status":"ok","timestamp":1669115396618,"user_tz":-330,"elapsed":1040,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"bfbe4362-eb3d-4a8c-f653-10dc1e4aac1d","colab":{"base_uri":"https://localhost:8080/"}},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["[[0]\n"," [0]\n"," [0]\n"," ...\n"," [0]\n"," [0]\n"," [0]]\n","<class 'numpy.ndarray'>\n"]}]},{"cell_type":"code","source":["input_arr = np.array(arr)"],"metadata":{"id":"K1KYjyXJr76w"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["Building the CNN model"],"metadata":{"id":"zO9j4yCPq_4h"}},{"cell_type":"code","source":["input_arr = input_arr.astype('float32')\n","input_arr /= 255\n","print(np.shape(input_arr))"],"metadata":{"id":"8eQM7dwEpVHH","executionInfo":{"status":"ok","timestamp":1669125528594,"user_tz":-330,"elapsed":582,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"dbb49268-96bd-4f4b-d5eb-73d46771b435","colab":{"base_uri":"https://localhost:8080/"}},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["(1640, 30, 30, 3)\n"]}]},{"cell_type":"code","source":["input_arr_train, input_arr_test, image_labels_train, image_labels_test = train_test_split(input_arr, image_labels, test_size = 0.2, random_state = 4)"],"metadata":{"id":"VTYY7AA8pgUf"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["batch_size = 16\n","nb_classes =5\n","nb_epochs = 5\n","img_rows, img_columns = 30, 30\n","img_channel = 3\n","nb_filters = 32\n","nb_pool = 2\n","nb_conv = 3"],"metadata":{"id":"8j-jUgWyqGM1"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["model = tf.keras.Sequential([\n","    tf.keras.layers.Conv2D(32, (3,3), padding='same', activation=tf.nn.relu,\n","                           input_shape=(30, 30, 3)),\n","    tf.keras.layers.MaxPooling2D((2, 2), strides=2),\n","    tf.keras.layers.Conv2D(32, (3,3), padding='same', activation=tf.nn.relu),\n","    tf.keras.layers.MaxPooling2D((2, 2), strides=2),\n","    tf.keras.layers.Dropout(0.5),\n","    tf.keras.layers.Flatten(),\n","    tf.keras.layers.Dense(128, activation=tf.nn.relu),\n","    tf.keras.layers.Dense(5,  activation=tf.nn.softmax)\n","])"],"metadata":{"id":"Vtg7W-mws_Fh"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["model.compile(optimizer='adam',loss='sparse_categorical_crossentropy',metrics=['accuracy'])"],"metadata":{"id":"0NPGEUICtADO"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["model.fit(input_arr_train, image_labels_train, batch_size = batch_size, epochs = nb_epochs, verbose = 1, validation_data = (input_arr_test, image_labels_test))"],"metadata":{"id":"xMkBoUP5tFXC","executionInfo":{"status":"ok","timestamp":1669125556084,"user_tz":-330,"elapsed":13983,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"428760b4-a902-49bd-fa41-20ace0ebe4ce","colab":{"base_uri":"https://localhost:8080/"}},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Epoch 1/5\n","82/82 [==============================] - 3s 31ms/step - loss: 0.6087 - accuracy: 0.8476 - val_loss: 0.4266 - val_accuracy: 0.8841\n","Epoch 2/5\n","82/82 [==============================] - 2s 27ms/step - loss: 0.5034 - accuracy: 0.8620 - val_loss: 0.4316 - val_accuracy: 0.9085\n","Epoch 3/5\n","82/82 [==============================] - 4s 44ms/step - loss: 0.4726 - accuracy: 0.8758 - val_loss: 0.3825 - val_accuracy: 0.9146\n","Epoch 4/5\n","82/82 [==============================] - 2s 27ms/step - loss: 0.4731 - accuracy: 0.8880 - val_loss: 0.3560 - val_accuracy: 0.9146\n","Epoch 5/5\n","82/82 [==============================] - 2s 27ms/step - loss: 0.4436 - accuracy: 0.8910 - val_loss: 0.3695 - val_accuracy: 0.9146\n"]},{"output_type":"execute_result","data":{"text/plain":["<keras.callbacks.History at 0x7fd01b1867d0>"]},"metadata":{},"execution_count":119}]},{"cell_type":"code","source":["score = model.evaluate(input_arr_test, image_labels_test, verbose = 0 )\n","print(\"Test Score: \", score[0])\n","print(\"Test accuracy: \", score[1])"],"metadata":{"id":"MAxDUgSgtQQ9","executionInfo":{"status":"ok","timestamp":1669125571559,"user_tz":-330,"elapsed":336,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"9cc8ce11-18c8-4fbd-ca0d-142fc1ad2c36","colab":{"base_uri":"https://localhost:8080/"}},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Test Score:  0.36945655941963196\n","Test accuracy:  0.9146341681480408\n"]}]},{"cell_type":"markdown","source":[],"metadata":{"id":"s9bmw34ZplAF"}},{"cell_type":"markdown","source":[],"metadata":{"id":"3Idx9CWNplRt"}},{"cell_type":"markdown","source":["Prediction using the built CNN model:"],"metadata":{"id":"TiOxTENVpm9E"}},{"cell_type":"code","source":["#Enter the file path of the image\n","predict_image = tf.keras.utils.img_to_array(tf.keras.utils.load_img('/content/drive/MyDrive/ET610-Endsem-Q1/Data/71_3.jpg',color_mode = 'rgb', target_size=(30,30,1))).reshape(1,30,30,3)\n","image_pred = model.predict(predict_image)\n","class_labels = ['Neutral','Boredom','Engagement','Confusion','Frustration']\n","pred = np.argmax(image_pred, axis=-1)\n","print(image_pred)\n","print(class_labels[pred[0]])"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"FbLhh01_obgW","executionInfo":{"status":"ok","timestamp":1669125595244,"user_tz":-330,"elapsed":5,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"0d351e1c-109a-446f-cb17-1a0009175a01"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["1/1 [==============================] - 0s 116ms/step\n","[[0. 0. 0. 0. 1.]]\n","Frustration\n"]}]},{"cell_type":"markdown","source":["Pretrained model using ResNet50\n"],"metadata":{"id":"TQmXO9EmxWvp"}},{"cell_type":"code","source":["import tensorflow as tf\n","from tensorflow import keras"],"metadata":{"id":"RVRfpHFJXQZF"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["train=[]\n","for i in range(0,164):\n","  for j in range(1,11):\n","    img = tf.keras.utils.load_img('/content/drive/MyDrive/ET610-Endsem-Q1/Data/'+(str)(i)+'_'+(str)(j)+'.jpg', grayscale=False,\n","    color_mode='rgb',\n","    target_size=(299,299,1),\n",")\n","    train1 = tf.keras.utils.img_to_array(img)\n","    train.append(train1)  # Convert single image to a batch."],"metadata":{"id":"Bd8kVR5rKNW0"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["train_arr = np.array(train)"],"metadata":{"id":"8goxVRWeS_hc"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["img_train, img_test, labels_train, labels_test = train_test_split(train_arr, image_labels, test_size=0.2, random_state=100)"],"metadata":{"id":"oFPhFCjnCmgV"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["from keras.applications.resnet import ResNet50, preprocess_input\n","\n","#Loading the ResNet50 model with pre-trained ImageNet weights\n","model = ResNet50(weights='imagenet', include_top=False, input_shape=(299, 299, 3))"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"LYywT_xzO1lV","executionInfo":{"status":"ok","timestamp":1669122707344,"user_tz":-330,"elapsed":4021,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"a045cac8-79bb-44d0-b2d1-c2200b222dea"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/resnet/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5\n","94765736/94765736 [==============================] - 1s 0us/step\n"]}]},{"cell_type":"code","source":["from keras.models import Sequential\n","from keras.layers import Dense, Conv2D, MaxPooling2D\n","from keras.layers import Dropout, Flatten, GlobalAveragePooling2D\n","model = Sequential()\n","model.add(GlobalAveragePooling2D(input_shape=(299,299,3)))\n","model.add(Dropout(0.01))\n","model.add(Dense(5, activation='softmax'))\n","# model.summary()"],"metadata":{"id":"NxsqAg-zc6C0"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["model.compile(loss='sparse_categorical_crossentropy', optimizer='adam', \n","              metrics=['accuracy'])"],"metadata":{"id":"rS-UdfsneDGW"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["model.fit(img_train, labels_train, epochs=20)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"nO_avNkpebBb","executionInfo":{"status":"ok","timestamp":1669126625918,"user_tz":-330,"elapsed":16900,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"c49cd93e-9342-4bb5-e225-f38595a8a51f"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Epoch 1/20\n","41/41 [==============================] - 1s 21ms/step - loss: 1.7181 - accuracy: 0.0274\n","Epoch 2/20\n","41/41 [==============================] - 1s 21ms/step - loss: 1.6522 - accuracy: 0.1517\n","Epoch 3/20\n","41/41 [==============================] - 1s 20ms/step - loss: 1.5877 - accuracy: 0.4505\n","Epoch 4/20\n","41/41 [==============================] - 1s 20ms/step - loss: 1.5257 - accuracy: 0.5633\n","Epoch 5/20\n","41/41 [==============================] - 1s 21ms/step - loss: 1.4664 - accuracy: 0.8537\n","Epoch 6/20\n","41/41 [==============================] - 1s 21ms/step - loss: 1.4097 - accuracy: 0.8537\n","Epoch 7/20\n","41/41 [==============================] - 1s 21ms/step - loss: 1.3550 - accuracy: 0.8537\n","Epoch 8/20\n","41/41 [==============================] - 1s 21ms/step - loss: 1.3035 - accuracy: 0.8537\n","Epoch 9/20\n","41/41 [==============================] - 1s 20ms/step - loss: 1.2544 - accuracy: 0.8537\n","Epoch 10/20\n","41/41 [==============================] - 1s 20ms/step - loss: 1.2076 - accuracy: 0.8537\n","Epoch 11/20\n","41/41 [==============================] - 1s 20ms/step - loss: 1.1635 - accuracy: 0.8537\n","Epoch 12/20\n","41/41 [==============================] - 1s 20ms/step - loss: 1.1221 - accuracy: 0.8537\n","Epoch 13/20\n","41/41 [==============================] - 1s 21ms/step - loss: 1.0830 - accuracy: 0.8537\n","Epoch 14/20\n","41/41 [==============================] - 1s 21ms/step - loss: 1.0466 - accuracy: 0.8537\n","Epoch 15/20\n","41/41 [==============================] - 1s 20ms/step - loss: 1.0127 - accuracy: 0.8537\n","Epoch 16/20\n","41/41 [==============================] - 1s 20ms/step - loss: 0.9809 - accuracy: 0.8537\n","Epoch 17/20\n","41/41 [==============================] - 1s 21ms/step - loss: 0.9513 - accuracy: 0.8537\n","Epoch 18/20\n","41/41 [==============================] - 1s 21ms/step - loss: 0.9240 - accuracy: 0.8537\n","Epoch 19/20\n","41/41 [==============================] - 1s 21ms/step - loss: 0.8985 - accuracy: 0.8537\n","Epoch 20/20\n","41/41 [==============================] - 1s 20ms/step - loss: 0.8752 - accuracy: 0.8537\n"]},{"output_type":"execute_result","data":{"text/plain":["<keras.callbacks.History at 0x7fd09bede8d0>"]},"metadata":{},"execution_count":157}]},{"cell_type":"code","source":["score  = model.evaluate(img_test, labels_test)\n","print('Accuracy on the Test Images: ', score[1])"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"7wybnO84elLN","executionInfo":{"status":"ok","timestamp":1669126629452,"user_tz":-330,"elapsed":859,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"963ec1b2-8294-422e-d9bb-86f24b12fc40"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["11/11 [==============================] - 0s 20ms/step - loss: 0.8231 - accuracy: 0.8811\n","Accuracy on the Test Images:  0.8810975551605225\n"]}]},{"cell_type":"markdown","source":["Image Prediction"],"metadata":{"id":"Bc9H4Lc-qoW2"}},{"cell_type":"code","source":["#Enter file path here\n","predict_image = tf.keras.utils.img_to_array(tf.keras.utils.load_img('/content/drive/MyDrive/ET610-Endsem-Q1/Data/0_5.jpg',color_mode = 'rgb', target_size=(299,299,1))).reshape(1,299,299,3)\n","image_pred = model.predict(predict_image)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"bUYNXb7GfgYC","executionInfo":{"status":"ok","timestamp":1669126632686,"user_tz":-330,"elapsed":12,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"a4b09543-71cf-4ae6-fcb4-c8269de62a1a"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["1/1 [==============================] - 0s 45ms/step\n"]}]},{"cell_type":"code","source":["class_labels = ['Neutral','Boredom','Engagement','Confusion','Frustration']\n","pred = np.argmax(image_pred, axis=-1)"],"metadata":{"id":"LXFxp7YGg8yd"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["print(class_labels[pred[0]])\n","#Result appears here"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"9EnzgjRbmYTw","executionInfo":{"status":"ok","timestamp":1669126637320,"user_tz":-330,"elapsed":10,"user":{"displayName":"Raghav Rander","userId":"11879286015926590180"}},"outputId":"fce415ec-5be9-42f4-def3-71f6a90cf07a"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Engagement\n"]}]},{"cell_type":"code","source":[],"metadata":{"id":"Ub0d5lYfsCdn"},"execution_count":null,"outputs":[]}],"metadata":{"colab":{"provenance":[{"file_id":"/v2/external/notebooks/intro.ipynb","timestamp":1668894512479}]},"kernelspec":{"display_name":"Python 3","name":"python3"},"accelerator":"TPU","gpuClass":"standard"},"nbformat":4,"nbformat_minor":0}